define("command",[],function(){return{commands:{go:{pattern:/^go(\s+)?(\d+)?$/i,run:function(t){return this.move(this.getCurrentDirection(),t[1]||1)}},tun:{pattern:/^tun\s+(lef|rig|bac)$/i,run:function(t){return this.turn({lef:-90,rig:90,bac:180}[t[0].toLowerCase()])}},tra:{pattern:/^tra\s+(top|rig|bot|lef)(\s+)?(\d+)?$/i,run:function(t){var e={top:TOP,rig:RIGHT,bot:BOTTOM,lef:LEFT}[t[0].toLowerCase()];return this.move(e,t[2]||1)}},mov:{pattern:/^mov\s+(top|rig|bot|lef)(\s+)?(\d+)?$/i,run:function(t){var e={top:TOP,rig:RIGHT,bot:BOTTOM,lef:LEFT}[t[0].toLowerCase()];return this.turn(null,e),this.move(e,t[2]||1)}},"mov to":{pattern:/^mov\s+to\s+(\d+)?,(\d+)?$/i,run:function(t){return this.search(t)}},build:{pattern:/^build$/i,run:function(){return this.build()}},bru:{pattern:/^bru\s+?(.*)$/i,run:function(t){return this.setColor(t)}}}}}),define("utils",[],function(){return{$:function(t){return document.querySelector(t)},$a:function(t){return document.querySelectorAll(t)},inList:function(t,e){return e.some(function(e){return e.x===t.x&&e.y===t.y})},addEvent:function(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i},getTargetIndex:function(t,e){for(var i=0,n=e.length;i<n;i++){var o=e[i];if(o.x===t.x&&o.y===t.y)return i}},comparisonByProperty:function(t){return function(e,i){return i[t]-e[t]}}}}),define("editor",["command","utils"],function(t,e){function i(){this.taskQueue=[],this.$editor=e.$(".commander-editor"),this.$lineArea=e.$(".commander-lines"),this.init()}return i.prototype.init=function(){this.update(),e.addEvent(this.$editor,"keydown",this.hotKey.bind(this)),e.addEvent(this.$editor,"input",this.update.bind(this)),e.addEvent(this.$editor,"scroll",this.scroll.bind(this))},i.prototype.hotKey=function(t){13!==t.keyCode&&37!==t.keyCode&&38!==t.keyCode&&39!==t.keyCode&&40!==t.keyCode||t.stopPropagation()},i.prototype.scroll=function(t){this.$lineArea.style.top=-this.$editor.scrollTop+"px"},i.prototype.update=function(){for(var t="",e=this.$editor.value.match(/\n/g),i=e?e.length+1:1,n=1;n<=i;n++)t+="<div class='commander-lines-item'>"+n+"</div>";this.$lineArea.innerHTML=t},i.prototype.getTask=function(e,i){for(var n in t.commands)if(t.commands[n].pattern.test(e))return{run:t.commands[n].run,params:e.match(t.commands[n].pattern).slice(1)}},i.prototype.setMark=function(t,e){t<0||(this.$lineArea.children[t].className=e)},{Editor:i}}),define("map",["utils"],function(t){function e(){this.rows=20,this.columns=20,this.$boxs=null,this.$element=t.$(".boxbot-map"),this.init(20,20)}return e.prototype.init=function(e,i){this.create(e,i),this.rows=e,this.columns=i,this.$boxs=t.$a("td")},e.prototype.create=function(t,e){var i=document.createElement("table"),n=document.createElement("tbody");this.$element.innerHTML&&(this.$element.innerHTML="");for(var o=0;o<t+1;o++){n.insertRow(o);for(var r=0;r<e+1;r++){var s=n.rows[o].insertCell(r);0===o&&0===r?s.className="x-axis":0===o?(s.innerText=r,s.className="x-axis"):0===r&&(s.innerText=o,s.className="y-axis")}}i.appendChild(n),this.$element.appendChild(i)},e.prototype.random=function(){return{x:Math.floor(Math.random()*this.rows+1),y:Math.floor(Math.random()*this.columns+1)}},e.prototype.getNode=function(t){return this.$boxs[t.y*(this.rows+1)+t.x]},e.prototype.getType=function(t){var e=this.getNode(t);return e?e.className:null},e.prototype.setWall=function(t){this.getNode(t).className="wall"},e.prototype.setColor=function(t,e){this.getNode(t).style.backgroundColor=e},{Map:e}}),define("finder",["utils"],function(t){function e(t){this.map=t,this.openList=[],this.closeList=[],this.result=[]}return e.prototype.clear=function(){this.openList=[],this.closeList=[],this.result=[]},e.prototype.getRounds=function(t){return[{x:t.x,y:t.y-1},{x:t.x+1,y:t.y},{x:t.x,y:t.y+1},{x:t.x-1,y:t.y}]},e.prototype.filter=function(e){var i=this;return e.filter(function(e){return""===i.map.getType({x:e.x,y:e.y})&&!t.inList(e,i.closeList)&&!t.inList(e,i.openList)})},e.prototype.backtrace=function(t,e){return e.x===t.x&&e.y===t.y?this.result:(this.result.unshift({x:e.x,y:e.y}),this.backtrace(t,e.parent))},e.prototype.findWay=function(t,e,i){return(i={"A*":this.AStar,BFS:this.bfs,DFS:this.dfs}[i]).call(this,t,e)},e.prototype.bfs=function(e,i){var n=this;for(this.clear(),this.openList=[e];this.openList.length;){var o=this.openList.shift();if(t.inList(o,this.closeList)||this.closeList.push(o),o.x===i.x&&o.y===i.y)return this.backtrace(e,o);this.filter(this.getRounds(o)).forEach(function(t){t.parent=o,n.openList.push(t)})}throw new Error("无法寻路")},e.prototype.dfs=function(e,i){var n=this;for(this.clear(),this.openList=[e];this.openList.length;){var o=this.openList.pop();if(t.inList(o,this.closeList)||this.closeList.push(o),o.x===i.x&&o.y===i.y)return this.backtrace(e,o);this.filter(this.getRounds(o)).forEach(function(t){t.parent=o,n.openList.push(t)})}throw new Error("无法寻路")},e.prototype.AStar=function(e,i){var n=null,o=null;if(this.clear(),this.map.getType(i))throw new Error("无法到达 ["+i.x+","+i.y+"]");if(e.x!==i.x||e.y!==i.y){for(this.openList.push({x:e.x,y:e.y,G:0});!(n=t.getTargetIndex({x:i.x,y:i.y},this.openList));){var r=this.openList.pop();t.inList(r,this.closeList)||this.closeList.push(r);var s=this.filter(this.getRounds(r)).map(function(t){return t.parent=r,t.G=r.G+10,t.H=10*Math.abs(i.x-t.x)+10*Math.abs(i.y-t.y),t.F=t.G+t.H,t});if(this.openList=this.openList.concat(s),!this.openList.length)throw new Error("无法寻路");this.openList.sort(t.comparisonByProperty("F"))}return n?(o=this.openList[n],this.backtrace(e,o)):[]}},{Finder:e}});var BOTTOM=0,LEFT=90,TOP=180,RIGHT=270;define("boxbot",["map","finder","utils"],function(t,e,i){function n(){this.map=new t.Map,this.finder=new e.Finder(this.map),this.$robot=i.$(".boxbot"),this.gridWidth=null,this.gridHeight=null,this.algorithm="A*",this.$algorithmBtn=i.$(".algorithm"),this.init(),i.addEvent(this.$algorithmBtn,"change",this.setAlgorithm.bind(this))}return n.prototype.init=function(){this.gridWidth=this.$robot.clientWidth,this.gridHeight=this.$robot.clientHeight,this.$robot.style.top=this.gridHeight+"px",this.$robot.style.left=this.gridWidth+"px",this.$robot.style.transform="rotate(0deg)"},n.prototype.setAlgorithm=function(t){t=t||event,this.algorithm=t.target.value},n.prototype.turn=function(t,e){var i=null,n=parseInt(/-?\d*\.?\d/.exec(this.$robot.style.transform)),o=this.getCurrentDirection(),r={0:{0:0,90:90,180:180,270:-90},90:{90:0,180:90,270:180,0:-90},180:{180:0,270:90,0:180,90:-90},270:{270:0,0:90,90:180,180:-90}};i=t?n+t:n+r[o][e],this.$robot.style.transform="rotate("+i+"deg)"},n.prototype.getCurrentDirection=function(){var t=parseFloat(/-?\d*\.?\d/.exec(this.$robot.style.transform));return(t%=360)>=0?t:t+360},n.prototype.getCurrentPosition=function(){var t=this.$robot,e=t.style.top.replace("px",""),i=t.style.left.replace("px","");return{x:Math.round(i/t.clientWidth),y:Math.round(e/t.clientHeight)}},n.prototype.getOffsetPosition=function(t,e){var i={0:[0,1],90:[-1,0],180:[0,-1],270:[1,0]}[t];return{x:i[0]*e,y:i[1]*e}},n.prototype.getPosition=function(t,e){var i=null,n=null;return null===t&&(t=this.getCurrentDirection()),i=this.getCurrentPosition(),n=this.getOffsetPosition(t,e),{x:i.x+n.x,y:i.y+n.y}},n.prototype.move=function(t,e){var i=null;return this.checkPath(t,e),i=this.getPosition(t,e),this.moveTo(i,!1)},n.prototype.moveTo=function(t,e){if(e=void 0===e||e){var i=this.getCurrentPosition(),n=[t.x-i.x,t.y-i.y];n[0]<0?this.turn(null,LEFT):n[0]>0?this.turn(null,RIGHT):n[1]<0?this.turn(null,TOP):n[1]>0&&this.turn(null,BOTTOM)}this.$robot.style.left=t.x*this.gridWidth+"px",this.$robot.style.top=t.y*this.gridHeight+"px"},n.prototype.search=function(t){if(t={x:parseInt(t[0]),y:parseInt(t[1])},null!==this.map.getType(t)){var e=this.getCurrentPosition(),i=t;return this.finder.findWay(e,i,this.algorithm)}throw new Error("无法到达["+t.x+","+t.y+"]")},n.prototype.build=function(){var t=this.getPosition(this.getCurrentDirection(),1);if(this.map.getType(t))throw console.log(this.map.getType(t)),new Error("前方无法修墙");this.map.setWall(t)},n.prototype.setColor=function(t){var e=this.getPosition(this.getCurrentDirection(),1);if("wall"!==this.map.getType(e))throw new Error("前方没有墙");this.map.setColor(e,t)},n.prototype.checkPath=function(t,e){for(var i=this.getCurrentPosition(),n=this.getOffsetPosition(t,1),o=1;o<=e;o++){var r=i.x+o*n.x,s=i.y+o*n.y,a=this.map.getType({x:r,y:s});if(null===a||""!==a)throw new Error("无法到达["+r+","+s+"]")}},n.prototype.control=function(t){t=t||event;var e={37:LEFT,38:TOP,39:RIGHT,40:BOTTOM}[t.keyCode];if(void 0!==e)if(t.preventDefault(),e===this.getCurrentDirection())try{this.move(e,1)}catch(t){console.log(t)}else this.turn(null,e);else 13===t.keyCode&&this.build()},{Boxbot:n}}),define("main",["editor","boxbot","utils"],function(t,e,i){function n(){this.speed=300,this.algorithm="A*",this.taskQueue=[],this.editor=new t.Editor,this.robot=new e.Boxbot,this.$speedBtn=i.$(".speed"),this.$sizeBtn=i.$(".map-size"),this.$runBtn=i.$(".execute-btn"),this.$buildBtn=i.$(".random-btn"),this.$resetBtn=i.$(".reset-btn"),this.$tipsBtn=i.$(".tips-btn"),this.$closeBtn=i.$(".close"),this.init()}return n.prototype.init=function(){i.addEvent(this.$runBtn,"click",this.run.bind(this)),i.addEvent(this.$buildBtn,"click",this.build.bind(this)),i.addEvent(this.$sizeBtn,"change",this.setSize.bind(this)),i.addEvent(this.$speedBtn,"change",this.setSpeed.bind(this)),i.addEvent(this.$resetBtn,"click",this.reset.bind(this)),i.addEvent(this.$tipsBtn,"click",this.toggleTips.bind(this)),i.addEvent(this.$closeBtn,"click",this.toggleTips.bind(this)),i.addEvent(document,"keydown",this.control.bind(this))},n.prototype.setSize=function(t){t=t||event;var e=parseInt(t.target.value);i.$("article").className={20:"map-20x20",30:"map-30x30"}[e],this.taskQueue=[],this.robot.map.init(e,e),this.robot.init()},n.prototype.setSpeed=function(t){t=t||event,this.speed=t.target.value},n.prototype.build=function(){for(var t=this.robot.map,e=t.random();t.getType(e);)e=t.random();t.setWall(e)},n.prototype.reset=function(){for(var t=i.$a(".wall"),e=0,n=t.length;e<n;e++)t[e].removeAttribute("class")},n.prototype.toggleTips=function(){i.$(".tips").classList.toggle("hidden")},n.prototype.control=function(t){t=t||event;var e={37:LEFT,38:TOP,39:RIGHT,40:BOTTOM}[t.keyCode];if(void 0!==e)if(t.preventDefault(),e===this.robot.getCurrentDirection())try{this.robot.move(e,1)}catch(t){console.log(t)}else this.robot.turn(null,e);else 13===t.keyCode&&this.robot.build()},n.prototype.getCommands=function(){return this.editor.$editor.value.split("\n")},n.prototype.addTaskQueue=function(t){this.taskQueue.push(t)},n.prototype.start=function(){var t=0,e=this,i=null,n=setInterval(function(){if(e.taskQueue.length){i&&(t--,i--),t>=1&&e.editor.setMark(t-1,"commander-lines-item");var o=e.taskQueue.shift();try{var r=o.run.call(e.robot,o.params);r&&(i=r.length,r=r.map(function(t){return{run:e.robot.moveTo,params:t}}),Array.prototype.unshift.apply(e.taskQueue,r)),e.editor.setMark(t++,"success")}catch(i){e.editor.setMark(t,"error"),clearInterval(n),console.log(i)}}else clearInterval(n)},e.speed)},n.prototype.run=function(){var t=this,e=!0,i=this.getCommands();this.taskQueue=[],i.forEach(function(i,n){var o=t.editor.getTask(i);console.log(o),o?t.addTaskQueue(o):(e=!1,t.editor.setMark(n,"error"))}),e&&this.start()},{Main:n}}),requirejs.config({baseUrl:"./js",paths:{main:"main",map:"map",boxbot:"boxbot",command:"command",editor:"editor",finder:"finder",utils:"utils"}}),requirejs(["main"],function(t){new t.Main}),define("./src/app",["main"],function(){});