function inList(t,e){for(var o=0,i=e.length;o<i;o++){var r=e[o];if(r.x===t.x&&r.y===t.y)return o}return!1}function comparisonByProperty(t){return function(e,o){return o[t]-e[t]}}function $(t){return document.querySelector(t)}function $a(t){return document.querySelectorAll(t)}function addEvent(t,e,o){t.addEventListener?t.addEventListener(e,o,!1):t.attachEvent?t.attachEvent("on"+e,o):t["on"+e]=o}function Map(t,e){this.rows=t,this.columns=e,this.$element=$(".boxbot-map"),this.init(),this.$boxs=$a("td")}function Editor(){this.taskQueue=[],this.$editor=$(".commander-editor"),this.$lineArea=$(".commander-lines"),this.init()}function Boxbot(t){this.map=new Map(t,t),this.finder=new Finder(this.map),this.init(),this.$robot=$(".boxbot"),this.gridWidth=this.$robot.clientWidth,this.gridHeight=this.$robot.clientHeight}function Finder(t){this.map=t,this.openList=[],this.closeList=[],this.result=[]}function Application(){this.speed=300,this.taskQueue=[],this.editor=new Editor,this.robot=new Boxbot(20),this.$runBtn=$(".execute-btn"),this.$buildBtn=$(".random-btn"),this.init()}Map.prototype.init=function(){var t=document.createElement("table"),e=document.createElement("tbody");t.className=20===this.rows?"map-20x20":"map-30x30";for(var o=0;o<this.rows+1;o++){e.insertRow(o);for(var i=0;i<this.columns+1;i++){var r=e.rows[o].insertCell(i);0===o&&0===i?r.className="x-axis":0===o?(r.innerText=i,r.className="x-axis"):0===i&&(r.innerText=o,r.className="y-axis")}}t.appendChild(e),this.$element.appendChild(t)},Map.prototype.random=function(){return{x:Math.floor(Math.random()*this.rows+1),y:Math.floor(Math.random()*this.columns+1)}},Map.prototype.getNode=function(t){return this.$boxs[t.y*(this.rows+1)+t.x]},Map.prototype.getType=function(t){return this.getNode(t).className},Map.prototype.setWall=function(t){this.getNode(t).className="wall"},Map.prototype.setColor=function(t,e){this.getNode(t).style.backgroundColor=e},Editor.prototype.init=function(){addEvent(this.$editor,"input",this.update.bind(this)),addEvent(this.$editor,"scroll",this.scroll.bind(this))},Editor.prototype.scroll=function(t){this.$lineArea.style.top=-this.$editor.scrollTop+"px"},Editor.prototype.update=function(){for(var t="",e=this.$editor.value.match(/\n/g),o=e?e.length+1:1,i=1;i<=o;i++)t+="<div class='commander-lines-item'>"+i+"</div>";this.$lineArea.innerHTML=t},Editor.prototype.isTrue=function(t,e){for(var o in commands)if(commands[o].pattern.test(t)){if("function"==typeof e){var i=commands[o].run,r=t.match(commands[o].pattern).slice(1);e.call(app,{run:i,params:r})}return!0}return!1},Editor.prototype.setMark=function(t,e){t<0||(this.$lineArea.children[t].className=e)};var BOTTOM=0,LEFT=90,TOP=180,RIGHT=270;Boxbot.prototype.init=function(){var t=document.createElement("img");t.className="boxbot",t.src="img/bot.png",t.style.top=$("td").clientWidth+"px",t.style.left=$("td").clientHeight+"px",t.style.transform="rotate(0deg)",$("tbody").appendChild(t),addEvent(document,"keydown",this.control.bind(this))},Boxbot.prototype.turn=function(t,e){var o=null,i=parseInt(/-?\d*\.?\d/.exec(this.$robot.style.transform)),r=this.getCurrentDirection(),n={0:{0:0,90:90,180:180,270:-90},90:{90:0,180:90,270:180,0:-90},180:{180:0,270:90,0:180,90:-90},270:{270:0,0:90,90:180,180:-90}};o=t?i+t:i+n[r][e],this.$robot.style.transform="rotate("+o+"deg)"},Boxbot.prototype.getCurrentDirection=function(){var t=parseFloat(/-?\d*\.?\d/.exec(this.$robot.style.transform));return(t%=360)>=0?t:t+360},Boxbot.prototype.getCurrentPosition=function(){var t=this.$robot,e=t.style.top.replace("px",""),o=t.style.left.replace("px","");return{x:Math.round(o/t.clientWidth),y:Math.round(e/t.clientHeight)}},Boxbot.prototype.getOffsetPosition=function(t,e){var o={0:[0,1],90:[-1,0],180:[0,-1],270:[1,0]}[t];return{x:o[0]*e,y:o[1]*e}},Boxbot.prototype.getPosition=function(t,e){var o=null,i=null;return null===t&&(t=this.getCurrentDirection()),o=this.getCurrentPosition(),i=this.getOffsetPosition(t,e),{x:o.x+i.x,y:o.y+i.y}},Boxbot.prototype.move=function(t,e){var o=null;return this.checkPath(t,e),o=this.getPosition(t,e),this.moveTo(o,!1)},Boxbot.prototype.moveTo=function(t,e){if(e=void 0===e||e){var o=this.getCurrentPosition(),i=[t.x-o.x,t.y-o.y];i[0]<0?this.turn(null,LEFT):i[0]>0?this.turn(null,RIGHT):i[1]<0?this.turn(null,TOP):i[1]>0&&this.turn(null,BOTTOM)}this.$robot.style.left=t.x*this.gridWidth+"px",this.$robot.style.top=t.y*this.gridHeight+"px"},Boxbot.prototype.search=function(t){var e=this.getCurrentPosition(),o={x:parseInt(t[0]),y:parseInt(t[1])};return this.finder.findWay(e,o)},Boxbot.prototype.build=function(){var t=this.getPosition(this.getCurrentDirection(),1);if(this.map.getType(t))throw new Error("前方无法修墙");this.map.setWall(t)},Boxbot.prototype.setColor=function(t){var e=this.getPosition(this.getCurrentDirection(),1);if("wall"!==this.map.getType(e))throw new Error("前方没有墙");this.map.setColor(e,t)},Boxbot.prototype.checkPath=function(t,e){for(var o=this.getCurrentPosition(),i=this.getOffsetPosition(t,1),r=1;r<=e;r++){var n=o.x+r*i.x,s=o.y+r*i.y;if(this.map.getType({x:n,y:s}))throw new Error("无法到达["+n+","+s+"]")}},Boxbot.prototype.control=function(t){var e=t||window.event;switch(e.keyCode){case 13:this.build();break;case 37:this.turn(90);break;case 38:this.move(this.getCurrentDirection(),1),e.preventDefault();break;case 39:this.turn(-90);break;case 40:this.turn(180)}},Finder.prototype.getRounds=function(t){return[{x:t.x,y:t.y-1},{x:t.x+1,y:t.y},{x:t.x,y:t.y+1},{x:t.x-1,y:t.y}]},Finder.prototype.filter=function(t){var e=this;return t.filter(function(t){return!e.map.getType({x:t.x,y:t.y})&&!inList(t,e.closeList)})},Finder.prototype.findWay=function(t,e){var o=null,i=null;if(this.openList=[],this.closeList=[],this.result=[],this.map.getType(e))throw new Error("无法到达 ["+e.x+","+e.y+"]");if(t.x!==e.x||t.y!==e.y){for(this.openList.push({x:t.x,y:t.y,G:0});!(o=inList({x:e.x,y:e.y},this.openList));){var r=this.openList.pop();this.closeList.push(r);var n=this.filter(this.getRounds(r)).map(function(t){return t.parent=r,t.G=r.G+10,t.H=10*Math.abs(e.x-t.x)+10*Math.abs(e.y-t.y),t.F=t.G+t.H,t});if(this.openList=this.openList.concat(n),!this.openList.length)throw new Error("无法寻路");this.openList.sort(comparisonByProperty("F"))}if(!o)return[];for(i=this.openList[o];i.x!==t.x||i.y!==t.y;)this.result.unshift({x:i.x,y:i.y}),i=i.parent;return this.result}};var commands={go:{pattern:/^go(\s+)?(\d+)?$/i,run:function(t){return this.move(this.getCurrentDirection(),t[1]||1)}},tun:{pattern:/^tun\s+(lef|rig|bac)$/i,run:function(t){return this.turn({lef:-90,rig:90,bac:180}[t[0].toLowerCase()])}},tra:{pattern:/^tra\s+(top|rig|bot|lef)(\s+)?(\d+)?$/i,run:function(t){var e={top:TOP,rig:RIGHT,bot:BOTTOM,lef:LEFT}[t[0].toLowerCase()];return this.move(e,t[2]||1)}},mov:{pattern:/^mov\s+(top|rig|bot|lef)(\s+)?(\d+)?$/i,run:function(t){var e={top:TOP,rig:RIGHT,bot:BOTTOM,lef:LEFT}[t[0].toLowerCase()];return this.turn(null,e),this.move(e,t[2]||1)}},"mov to":{pattern:/^mov\s+to\s+(\d+)?,(\d+)?$/i,run:function(t){return this.search(t)}},build:{pattern:/^build$/i,run:function(){return this.build()}},bru:{pattern:/^bru\s+?(.*)$/i,run:function(t){return this.setColor(t)}}};Application.prototype.init=function(){addEvent(this.$runBtn,"click",this.run.bind(this)),addEvent(this.$buildBtn,"click",this.build.bind(this))},Application.prototype.build=function(){for(var t=this.robot.map,e=t.random();t.getType(e);)e=t.random();t.setWall(e)},Application.prototype.getCommands=function(){return this.editor.$editor.value.split("\n")},Application.prototype.addTaskQueue=function(t){this.taskQueue.push(t)},Application.prototype.start=function(){var t=0,e=this,o=null,i=setInterval(function(){if(console.log("sss"),e.taskQueue.length){o&&(t--,o--),t>=1&&e.editor.setMark(t-1,"commander-lines-item");var r=e.taskQueue.shift();try{var n=r.run.call(e.robot,r.params);n&&(o=n.length,n=n.map(function(t){return{run:e.robot.moveTo,params:t}}),Array.prototype.unshift.apply(e.taskQueue,n)),e.editor.setMark(t++,"success")}catch(o){e.editor.setMark(t,"error"),clearInterval(i),console.log(o)}}else clearInterval(i)},e.speed)},Application.prototype.run=function(){var t=this,e=!0,o=this.getCommands();this.taskQueue=[],o.forEach(function(o,i){t.editor.isTrue(o,t.addTaskQueue)||(e=!1,t.editor.setMark(i,"error"))}),e&&this.start()};var app=new Application;