function inList(t,e){for(var i=0,o=e.length;i<o;i++){var r=e[i];if(r.x===t.x&&r.y===t.y)return i}return!1}function comparisonByProperty(t){return function(e,i){return i[t]-e[t]}}function $(t){return document.querySelector(t)}function $a(t){return document.querySelectorAll(t)}function addEvent(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i}function Map(){this.rows=20,this.columns=20,this.$boxs=null,this.$element=$(".boxbot-map"),this.init(20,20)}function Editor(){this.taskQueue=[],this.$editor=$(".commander-editor"),this.$lineArea=$(".commander-lines"),this.init()}function Boxbot(){this.map=new Map,this.finder=new Finder(this.map),this.$robot=$(".boxbot"),this.gridWidth=null,this.gridHeight=null,this.init()}function Finder(t){this.map=t,this.openList=[],this.closeList=[],this.result=[]}function Application(){this.speed=300,this.taskQueue=[],this.editor=new Editor,this.robot=new Boxbot,this.$speedBtn=$(".speed"),this.$sizeBtn=$(".map-size"),this.$runBtn=$(".execute-btn"),this.$buildBtn=$(".random-btn"),this.$resetBtn=$(".reset-btn"),this.init()}Map.prototype.init=function(t,e){this.create(t,e),this.rows=t,this.columns=e,this.$boxs=$a("td")},Map.prototype.create=function(t,e){var i=document.createElement("table"),o=document.createElement("tbody");this.$element.innerHTML&&(this.$element.innerHTML="");for(var r=0;r<t+1;r++){o.insertRow(r);for(var n=0;n<e+1;n++){var s=o.rows[r].insertCell(n);0===r&&0===n?s.className="x-axis":0===r?(s.innerText=n,s.className="x-axis"):0===n&&(s.innerText=r,s.className="y-axis")}}i.appendChild(o),this.$element.appendChild(i)},Map.prototype.random=function(){return{x:Math.floor(Math.random()*this.rows+1),y:Math.floor(Math.random()*this.columns+1)}},Map.prototype.getNode=function(t){return this.$boxs[t.y*(this.rows+1)+t.x]},Map.prototype.getType=function(t){var e=this.getNode(t);return e?e.className:null},Map.prototype.setWall=function(t){this.getNode(t).className="wall"},Map.prototype.setColor=function(t,e){this.getNode(t).style.backgroundColor=e},Editor.prototype.init=function(){this.update(),addEvent(this.$editor,"input",this.update.bind(this)),addEvent(this.$editor,"scroll",this.scroll.bind(this))},Editor.prototype.scroll=function(t){this.$lineArea.style.top=-this.$editor.scrollTop+"px"},Editor.prototype.update=function(){for(var t="",e=this.$editor.value.match(/\n/g),i=e?e.length+1:1,o=1;o<=i;o++)t+="<div class='commander-lines-item'>"+o+"</div>";this.$lineArea.innerHTML=t},Editor.prototype.isTrue=function(t,e){for(var i in commands)if(commands[i].pattern.test(t)){if("function"==typeof e){var o=commands[i].run,r=t.match(commands[i].pattern).slice(1);e.call(app,{run:o,params:r})}return!0}return!1},Editor.prototype.setMark=function(t,e){t<0||(this.$lineArea.children[t].className=e)};var BOTTOM=0,LEFT=90,TOP=180,RIGHT=270;Boxbot.prototype.init=function(){this.gridWidth=this.$robot.clientWidth,this.gridHeight=this.$robot.clientHeight,this.$robot.style.top=this.gridHeight+"px",this.$robot.style.left=this.gridWidth+"px",this.$robot.style.transform="rotate(0deg)"},Boxbot.prototype.turn=function(t,e){var i=null,o=parseInt(/-?\d*\.?\d/.exec(this.$robot.style.transform)),r=this.getCurrentDirection(),n={0:{0:0,90:90,180:180,270:-90},90:{90:0,180:90,270:180,0:-90},180:{180:0,270:90,0:180,90:-90},270:{270:0,0:90,90:180,180:-90}};i=t?o+t:o+n[r][e],this.$robot.style.transform="rotate("+i+"deg)"},Boxbot.prototype.getCurrentDirection=function(){var t=parseFloat(/-?\d*\.?\d/.exec(this.$robot.style.transform));return(t%=360)>=0?t:t+360},Boxbot.prototype.getCurrentPosition=function(){var t=this.$robot,e=t.style.top.replace("px",""),i=t.style.left.replace("px","");return{x:Math.round(i/t.clientWidth),y:Math.round(e/t.clientHeight)}},Boxbot.prototype.getOffsetPosition=function(t,e){var i={0:[0,1],90:[-1,0],180:[0,-1],270:[1,0]}[t];return{x:i[0]*e,y:i[1]*e}},Boxbot.prototype.getPosition=function(t,e){var i=null,o=null;return null===t&&(t=this.getCurrentDirection()),i=this.getCurrentPosition(),o=this.getOffsetPosition(t,e),{x:i.x+o.x,y:i.y+o.y}},Boxbot.prototype.move=function(t,e){var i=null;return this.checkPath(t,e),i=this.getPosition(t,e),this.moveTo(i,!1)},Boxbot.prototype.moveTo=function(t,e){if(e=void 0===e||e){var i=this.getCurrentPosition(),o=[t.x-i.x,t.y-i.y];o[0]<0?this.turn(null,LEFT):o[0]>0?this.turn(null,RIGHT):o[1]<0?this.turn(null,TOP):o[1]>0&&this.turn(null,BOTTOM)}this.$robot.style.left=t.x*this.gridWidth+"px",this.$robot.style.top=t.y*this.gridHeight+"px"},Boxbot.prototype.search=function(t){if(t={x:parseInt(t[0]),y:parseInt(t[1])},null!==this.map.getType(t)){var e=this.getCurrentPosition(),i=t;return this.finder.findWay(e,i)}throw new Error("无法到达["+t.x+","+t.y+"]")},Boxbot.prototype.build=function(){var t=this.getPosition(this.getCurrentDirection(),1);if(this.map.getType(t))throw console.log(this.map.getType(t)),new Error("前方无法修墙");this.map.setWall(t)},Boxbot.prototype.setColor=function(t){var e=this.getPosition(this.getCurrentDirection(),1);if("wall"!==this.map.getType(e))throw new Error("前方没有墙");this.map.setColor(e,t)},Boxbot.prototype.checkPath=function(t,e){for(var i=this.getCurrentPosition(),o=this.getOffsetPosition(t,1),r=1;r<=e;r++){var n=i.x+r*o.x,s=i.y+r*o.y,a=this.map.getType({x:n,y:s});if(null===a||""!==a)throw new Error("无法到达["+n+","+s+"]")}},Boxbot.prototype.control=function(t){switch((t=t||event).keyCode){case 13:this.build();break;case 37:this.turn(90);break;case 38:try{this.move(this.getCurrentDirection(),1)}catch(t){console.log(t)}t.preventDefault();break;case 39:this.turn(-90);break;case 40:this.turn(180)}},Finder.prototype.getRounds=function(t){return[{x:t.x,y:t.y-1},{x:t.x+1,y:t.y},{x:t.x,y:t.y+1},{x:t.x-1,y:t.y}]},Finder.prototype.filter=function(t){var e=this;return t.filter(function(t){return!e.map.getType({x:t.x,y:t.y})&&!inList(t,e.closeList)})},Finder.prototype.findWay=function(t,e){var i=null,o=null;if(this.openList=[],this.closeList=[],this.result=[],this.map.getType(e))throw new Error("无法到达 ["+e.x+","+e.y+"]");if(t.x!==e.x||t.y!==e.y){for(this.openList.push({x:t.x,y:t.y,G:0});!(i=inList({x:e.x,y:e.y},this.openList));){var r=this.openList.pop();this.closeList.push(r);var n=this.filter(this.getRounds(r)).map(function(t){return t.parent=r,t.G=r.G+10,t.H=10*Math.abs(e.x-t.x)+10*Math.abs(e.y-t.y),t.F=t.G+t.H,t});if(this.openList=this.openList.concat(n),!this.openList.length)throw new Error("无法寻路");this.openList.sort(comparisonByProperty("F"))}if(!i)return[];for(o=this.openList[i];o.x!==t.x||o.y!==t.y;)this.result.unshift({x:o.x,y:o.y}),o=o.parent;return this.result}};var commands={go:{pattern:/^go(\s+)?(\d+)?$/i,run:function(t){return this.move(this.getCurrentDirection(),t[1]||1)}},tun:{pattern:/^tun\s+(lef|rig|bac)$/i,run:function(t){return this.turn({lef:-90,rig:90,bac:180}[t[0].toLowerCase()])}},tra:{pattern:/^tra\s+(top|rig|bot|lef)(\s+)?(\d+)?$/i,run:function(t){var e={top:TOP,rig:RIGHT,bot:BOTTOM,lef:LEFT}[t[0].toLowerCase()];return this.move(e,t[2]||1)}},mov:{pattern:/^mov\s+(top|rig|bot|lef)(\s+)?(\d+)?$/i,run:function(t){var e={top:TOP,rig:RIGHT,bot:BOTTOM,lef:LEFT}[t[0].toLowerCase()];return this.turn(null,e),this.move(e,t[2]||1)}},"mov to":{pattern:/^mov\s+to\s+(\d+)?,(\d+)?$/i,run:function(t){return this.search(t)}},build:{pattern:/^build$/i,run:function(){return this.build()}},bru:{pattern:/^bru\s+?(.*)$/i,run:function(t){return this.setColor(t)}}};Application.prototype.init=function(){addEvent(this.$runBtn,"click",this.run.bind(this)),addEvent(this.$buildBtn,"click",this.build.bind(this)),addEvent(this.$sizeBtn,"change",this.setSize.bind(this)),addEvent(this.$speedBtn,"change",this.setSpeed.bind(this)),addEvent(this.$resetBtn,"click",this.reset.bind(this)),addEvent(document,"keydown",this.robot.control.bind(this.robot))},Application.prototype.setSize=function(t){t=t||event;var e=parseInt(t.target.value);$("article").className={20:"map-20x20",30:"map-30x30"}[e],this.taskQueue=[],this.robot.map.init(e,e),this.robot.init()},Application.prototype.build=function(){for(var t=this.robot.map,e=t.random();t.getType(e);)e=t.random();t.setWall(e)},Application.prototype.reset=function(){for(var t=$a(".wall"),e=0,i=t.length;e<i;e++)t[e].removeAttribute("class")},Application.prototype.setSpeed=function(t){t=t||event,this.speed=t.target.value},Application.prototype.getCommands=function(){return this.editor.$editor.value.split("\n")},Application.prototype.addTaskQueue=function(t){this.taskQueue.push(t)},Application.prototype.start=function(){var t=0,e=this,i=null,o=setInterval(function(){if(e.taskQueue.length){i&&(t--,i--),t>=1&&e.editor.setMark(t-1,"commander-lines-item");var r=e.taskQueue.shift();try{var n=r.run.call(e.robot,r.params);n&&(i=n.length,n=n.map(function(t){return{run:e.robot.moveTo,params:t}}),Array.prototype.unshift.apply(e.taskQueue,n)),e.editor.setMark(t++,"success")}catch(i){e.editor.setMark(t,"error"),clearInterval(o),console.log(i)}}else clearInterval(o)},e.speed)},Application.prototype.run=function(){var t=this,e=!0,i=this.getCommands();this.taskQueue=[],i.forEach(function(i,o){t.editor.isTrue(i,t.addTaskQueue)||(e=!1,t.editor.setMark(o,"error"))}),e&&this.start()};var app=new Application;